# Delta for Sync System

## ADDED Requirements

### Requirement: Canonical Directory Structure

The system SHALL maintain a canonical source directory at `~/.ai-agent/` with the following structure:

- `manifest.json` -- configuration and rule metadata (gitignored)
- `rules/` -- plain markdown rule files, no agent-specific formatting (gitignored)
- `skills/` -- shared skill directories, copied from source agent (gitignored)
- `scripts/sync_agent_rules.py` -- the sync tool (committed, zero external dependencies)
- `README.md` -- documentation (committed)
- `.gitignore` -- excludes personal content from version control (committed)

#### Scenario: Fresh install

- GIVEN no `~/.ai-agent/` directory exists
- WHEN the user runs `sync_agent_rules.py init`
- THEN the directory structure is created and populated from selected sources

### Requirement: Repository Boundary

The system SHALL separate version-controlled tooling from personal content:

**Committed to git:**

- `scripts/sync_agent_rules.py` (the sync tool, zero external dependencies)
- `README.md`
- `.gitignore`
- `openspec/` (planning artifacts)

**Gitignored (local only):**

- `manifest.json` (contains user-specific agent targets and rule metadata)
- `rules/` (user's personal rules)
- `skills/` (user's personal skills)
- `docs/` (user's personal notes, plans, references)

#### Scenario: Clone by another user

- GIVEN the repo is cloned fresh from GitHub
- WHEN the new user runs `sync_agent_rules.py init`
- THEN the wizard creates their own `manifest.json`, `rules/`, and `skills/` from their local agent configs
- AND no previous user's personal content is present

#### Scenario: Commit safety

- GIVEN a user has run `init` and has `rules/`, `skills/`, and `manifest.json` locally
- WHEN they run `git status`
- THEN none of the personal content files appear as untracked or modified

### Requirement: Manifest Format

The manifest SHALL be a JSON file (`manifest.json`) containing:

- `version` -- schema version string
- `updated` -- ISO date of last sync
- `imported_from` -- list of agents rules were originally imported from
- `active_targets.rules` -- list of agents to sync rules to
- `active_targets.skills` -- list of agents to sync skills to
- `rules` -- array of rule entries, each with:
  - `id` -- unique slug identifier
  - `file` -- filename in `rules/`
  - `imported_from` -- source agent for provenance
  - `cursor` -- optional Cursor-specific metadata (`alwaysApply`, `description`, `globs`)
  - `exclude` -- optional array of agents to skip for this rule
- `skills.shared_dir` -- path to shared skills directory
- `agents_md.paths` -- array of AGENTS.md file paths to generate
- `agents_md.header` -- header line for generated AGENTS.md
- `agents_md.preamble` -- preamble text for generated AGENTS.md

The manifest is generated by `init` and read by `sync`. It uses JSON (stdlib `json` module) so the tool has zero external dependencies.

#### Scenario: Manifest controls sync targets

- GIVEN a manifest with `active_targets.rules: [cursor, codex, claude]`
- WHEN the user runs `sync`
- THEN only Cursor, Codex, and Claude Code rule files are generated
- AND other agents are untouched

#### Scenario: Per-rule exclusion

- GIVEN a rule with `exclude: [kiro, claude]`
- WHEN the user runs `sync`
- THEN that rule is not included in Kiro or Claude output
- AND the rule is included in all other active rule targets

### Requirement: Init Mode

The system SHALL provide an `init` subcommand that runs an interactive wizard:

1. If `manifest.json`, `rules/`, or `skills/` already exist, warn the user that `init` will overwrite existing canonical content in `~/.ai-agent/`. The warning must also clarify that source agent files (e.g., `~/.cursor/rules/`, `~/.codex/model-instructions.md`) are only read and never modified. Require explicit confirmation before proceeding. Exit if declined.
2. Prompt user to select which agents have existing rules (multi-select)
3. Scan selected sources and report findings (file counts, line counts, duplicates)
4. Prompt user to confirm import
5. Prompt user to select target agents for ongoing sync (multi-select)
6. If `agents-md` is selected as a target, prompt for output paths (comma-separated, default: none). If no paths are provided, `agents-md` is removed from active targets.
7. Write canonical rules, skills, and manifest
8. Run first sync

#### Scenario: Import from multiple sources with deduplication

- GIVEN agent A has N rule files and M shared skills
- AND agent B has a concatenated rules file with sections matching agent A's rules
- WHEN the user selects both as import sources
- THEN unique rules are imported and duplicates are skipped
- AND shared skills are copied to `~/.ai-agent/skills/`
- AND agent-specific metadata is preserved in manifest

#### Scenario: Init warns before overwriting existing canonical content

- GIVEN the user has previously run `init` and `~/.ai-agent/manifest.json` exists
- WHEN the user runs `init` again
- THEN the script warns that existing rules, skills, and manifest will be overwritten
- AND prompts for explicit confirmation before proceeding
- AND exits cleanly if the user declines

#### Scenario: Init reads but does not modify source agent files

- GIVEN existing agent config files
- WHEN `init` runs
- THEN source files are read but never modified or deleted
- AND the first `sync` overwrites agent configs with generated versions

### Requirement: Sync Mode

The system SHALL provide a `sync` subcommand that idempotently generates agent configs:

- Read manifest for active targets and rule definitions
- For each active rule target, generate the agent-native format
- For each active skill target, create/update symlinks
- All generated files include a header: `# Generated from ~/.ai-agent/ -- do not edit directly`

#### Scenario: Cursor generation

- GIVEN rules in canonical source with Cursor metadata
- WHEN `sync` runs with cursor in active targets
- THEN `.mdc` files are written to `~/.cursor/rules/`
- AND each file has YAML frontmatter with `alwaysApply` and `description`
- AND skill symlinks are created in `~/.cursor/skills/` pointing to `~/.ai-agent/skills/`

#### Scenario: Stale Cursor .mdc cleanup

- GIVEN a previous sync wrote `~/.cursor/rules/old-rule.mdc` with the generated header
- AND `old-rule` has since been removed from the manifest
- WHEN `sync` runs with cursor in active targets
- THEN `~/.cursor/rules/old-rule.mdc` is removed
- AND `.mdc` files without the generated header (user-created) are left untouched

#### Scenario: Codex generation

- GIVEN rules in canonical source
- WHEN `sync` runs with codex in active targets
- THEN `~/.codex/model-instructions.md` is written with all rules concatenated
- AND each rule section is prefixed with `## Rule: {id}`
- AND skill symlinks are created in `~/.codex/skills/` pointing to `~/.ai-agent/skills/`

#### Scenario: Claude Code generation

- GIVEN rules in canonical source
- WHEN `sync` runs with claude in active targets
- THEN `~/.claude/CLAUDE.md` is written with all rules concatenated

#### Scenario: Gemini CLI generation

- GIVEN rules in canonical source
- WHEN `sync` runs with gemini in active targets
- THEN `~/.gemini/GEMINI.md` is written with all rules concatenated
- AND skill symlinks are created in `~/.gemini/skills/` pointing to `~/.ai-agent/skills/`

#### Scenario: Kiro generation

- GIVEN rules in canonical source
- WHEN `sync` runs with kiro in active targets
- THEN `~/.kiro/steering/conventions.md` is written with all rules concatenated
- AND other files in `~/.kiro/steering/` (user-created, without the generated header) are left untouched

#### Scenario: Antigravity generation

- GIVEN active skill targets include antigravity
- WHEN `sync` runs
- THEN skill symlinks are created in `~/.gemini/antigravity/skills/` pointing to `~/.ai-agent/skills/`

#### Scenario: AGENTS.md generation

- GIVEN rules and configured AGENTS.md output paths in manifest
- WHEN `sync` runs with agents-md in active targets
- THEN each configured path is written with a condensed numbered list of all non-excluded rules
- AND each entry uses the format `N. **{id}** -- {summary}`
- AND the summary is derived from `cursor.description` if present, otherwise the first non-empty line of rule content (truncated to 120 chars)

### Requirement: Reconfigure Mode

The system SHALL provide a `reconfigure` subcommand that:

- Re-prompts for target agent selection (without re-importing)
- Updates `active_targets` in manifest
- Runs a sync with the new configuration

#### Scenario: Add a new target agent

- GIVEN manifest has certain active rule targets
- WHEN user runs `reconfigure` and adds a new agent
- THEN manifest is updated with the new target
- AND the new agent's config file is generated

### Requirement: CLI Flags

The system SHALL support the following flags on all subcommands:

- `--dry-run` -- print what would be written without modifying files
- `--diff` -- show diff between current files and what would be generated
- `--verbose` -- detailed logging output
- `--only <agent>` -- restrict sync to a single agent
- `--yes` -- skip interactive confirmation prompts

#### Scenario: Dry run

- GIVEN a configured manifest
- WHEN the user runs `sync --dry-run`
- THEN the script prints all files that would be written and their content summaries
- AND no files are created, modified, or deleted

### Requirement: Per-Agent Importers

The system SHALL include importers for each supported agent format. All importers operate on **user-level (global)** config only -- workspace-level rules (e.g., `<project>/.cursor/rules/`) are not imported.

All importers SHALL skip files that begin with the generated header (`# Generated from ~/.ai-agent/`). This prevents circular re-import when `init` is run after a previous `sync` has written to agent directories.

- **Cursor**: Read `~/.cursor/rules/*.mdc`, skip generated files, strip YAML frontmatter, extract metadata
- **Codex**: Read `~/.codex/model-instructions.md`, skip if generated, split on `## Source:` headers
- **Claude Code**: Read `~/.claude/CLAUDE.md`, skip if generated, split on `#` headers
- **Gemini CLI**: Read `~/.gemini/GEMINI.md`, skip if generated, split on `#` headers
- **Kiro**: Read `~/.kiro/steering/*.md`, skip generated files, one rule per file
- **Antigravity**: Scan `~/.gemini/antigravity/skills/` for non-symlink skills

#### Scenario: Cursor frontmatter parsing

- GIVEN a `.mdc` file with `---\nalwaysApply: true\ndescription: "example"\n---\n# Rule\nContent`
- WHEN the Cursor importer processes it
- THEN the rule content is `# Rule\nContent` (frontmatter stripped)
- AND the manifest entry has `cursor.alwaysApply: true` and `cursor.description: "example"`

#### Scenario: Skip previously generated files during re-import

- GIVEN a Codex `model-instructions.md` that starts with `# Generated from ~/.ai-agent/`
- WHEN the Codex importer runs
- THEN the file is skipped with a warning message
- AND no rules are imported from that source

### Requirement: Deduplication

The system SHALL deduplicate rules when importing from multiple sources:

- **Exact match**: skip the duplicate, record provenance from first source
- **Similar** (same heading, >80% content overlap via `difflib.SequenceMatcher`): flag for user review with diff
- **Unique**: import as new rule

#### Scenario: Exact duplicate across sources

- GIVEN agent A has a rule and agent B has the same rule content in its format
- WHEN both are imported
- THEN one canonical rule is created with `imported_from` set to the first source
- AND the duplicate is skipped with a log message

### Requirement: Skill Symlinks

The system SHALL manage skill symlinks for agents that support them (Cursor, Codex, Gemini CLI, Antigravity):

- Remove existing symlinks in the agent's skills dir that point into `~/.ai-agent/skills/`
- Create fresh symlinks for each shared skill directory
- Leave non-symlink entries (agent-native skills) untouched

#### Scenario: Skill sync preserves agent-native content

- GIVEN an agent has its own system skill directories (e.g., `.system/`)
- WHEN `sync` creates skill symlinks for that agent
- THEN agent-native directories are not modified or removed
- AND symlinks for shared skills are created alongside them

#### Scenario: Skill sync preserves non-managed symlinks

- GIVEN Codex skills dir has symlinks pointing to `~/.cursor/skills-cursor/create-rule` (agent-specific skills)
- AND symlinks pointing to `~/.ai-agent/skills/some-skill` (managed by sync)
- WHEN `sync` runs
- THEN only symlinks pointing into `~/.ai-agent/skills/` are removed and re-created
- AND symlinks pointing elsewhere (e.g., `~/.cursor/skills-cursor/`) are left untouched

